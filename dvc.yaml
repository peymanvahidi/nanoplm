# This is a template for a DVC pipeline for the data pipeline.
# DO NOT EDIT THIS FILE, IT IS AUTO-GENERATED.
# The KD stages are only run when pipeline_mode is 'distillation'.
stages:

  download:
    cmd: nanoplm data download --url ${data_dirs.url} -o ${data_dirs.compressed_fasta}
    params:
      - data_dirs.url
      - data_dirs.compressed_fasta
    outs:
      - ${data_dirs.compressed_fasta}

  extract:
    cmd: nanoplm data extract -i ${data_dirs.compressed_fasta} -o ${data_dirs.extracted_fasta}
    deps:
      - ${data_dirs.compressed_fasta}
    params:
      - data_dirs.compressed_fasta
      - data_dirs.extracted_fasta
    outs:
      - ${data_dirs.extracted_fasta}

  shuffle:
    cmd: nanoplm data shuffle -i ${data_dirs.extracted_fasta} -o ${data_dirs.shuffled_fasta} --backend ${data_params.shuffle_backend} --seed ${data_params.shuffle_seed}
    deps:
      - ${data_dirs.extracted_fasta}
    params:
      - data_dirs.shuffled_fasta
      - data_params.shuffle_backend
      - data_params.shuffle_seed
    outs:
      - ${data_dirs.shuffled_fasta}

  filter:
    cmd: nanoplm data filter -i ${data_dirs.shuffled_fasta} -o ${data_dirs.filtered_fasta} --min-seq-len ${data_params.min_seq_len} --max-seq-len ${data_params.max_seq_len} --seqs-num ${data_params.seqs_num} --skip-n ${data_params.filter_skip_n}
    deps:
      - ${data_dirs.shuffled_fasta}
    params:
      - data_dirs.shuffled_fasta
      - data_params.min_seq_len
      - data_params.max_seq_len
      - data_params.seqs_num
      - data_params.filter_skip_n
    outs:
      - ${data_dirs.filtered_fasta}

  split:
    cmd: nanoplm data split -i ${data_dirs.filtered_fasta} -o ${data_dirs.splitted_fasta_dir} --val-ratio ${data_params.val_ratio}
    deps:
      - ${data_dirs.filtered_fasta}
    params:
      - data_dirs.filtered_fasta
      - data_dirs.splitted_fasta_dir
      - data_params.val_ratio
    outs:
      - ${data_dirs.splitted_fasta_dir}

  save_kd_train_dataset:
    cmd: nanoplm data save-kd-dataset -i ${data_dirs.splitted_fasta_dir}/train.fasta -o ${distillation_config.output_dir}/train --teacher-model ${distillation_config.teacher_model} --max-seq-len ${data_params.max_seq_len} --samples-per-shard ${distillation_config.samples_per_shard} --batch-size ${distillation_config.embed_calc_batch_size} --device ${data_params.device} --skip-n ${data_params.filter_skip_n}
    deps:
      - ${data_dirs.splitted_fasta_dir}/train.fasta
    params:
      - data_dirs.splitted_fasta_dir
      - distillation_config.output_dir
      - distillation_config.teacher_model
      - distillation_config.samples_per_shard
      - distillation_config.embed_calc_batch_size
      - data_params.max_seq_len
      - data_params.filter_skip_n
    outs:
      - ${distillation_config.output_dir}/train

  save_kd_val_dataset:
    cmd: nanoplm data save-kd-dataset -i ${data_dirs.splitted_fasta_dir}/val.fasta -o ${distillation_config.output_dir}/val --teacher-model ${distillation_config.teacher_model} --max-seq-len ${data_params.max_seq_len} --samples-per-shard ${distillation_config.samples_per_shard} --batch-size ${distillation_config.embed_calc_batch_size} --device ${data_params.device} --skip-n ${data_params.filter_skip_n}
    deps:
      - ${data_dirs.splitted_fasta_dir}/val.fasta
    params:
      - data_dirs.splitted_fasta_dir
      - distillation_config.output_dir
      - distillation_config.teacher_model
      - distillation_config.samples_per_shard
      - distillation_config.embed_calc_batch_size
      - data_params.max_seq_len
      - data_params.filter_skip_n
    outs:
      - ${distillation_config.output_dir}/val
